# Data Model: Authentication and Security in Phase II

## Overview
Data model for authentication and security features using Better Auth and JWT tokens.

## Entity Definitions

### User
Represents an authenticated user managed by Better Auth system.

**Fields**:
- `id`: UUID (Primary Key, auto-generated by Better Auth)
- `email`: String (Unique, required, validated as email format)
- `username`: String (Unique, optional)
- `created_at`: DateTime (Auto-generated)
- `updated_at`: DateTime (Auto-generated, updates on modification)
- `email_verified`: Boolean (Default: False)
- `disabled`: Boolean (Default: False)

**Note**: User entity is primarily managed by Better Auth system, but referenced by application entities.

### JWT Token
Represents a JSON Web Token with user identity claims.

**Fields** (in JWT payload):
- `sub`: String (Subject - user ID)
- `iat`: Integer (Issued At - timestamp)
- `exp`: Integer (Expiration Time - timestamp)
- `nbf`: Integer (Not Before - timestamp)
- `iss`: String (Issuer)
- `aud`: String (Audience)
- `jti`: String (JWT ID - for token tracking if needed)

**Validation Rules**:
- Token must be properly signed with shared secret
- Token must not be expired
- Token must not be used before Not Before time
- Subject must correspond to a valid user ID

### Auth Session (Conceptual - for tracking)
Represents an authentication session for monitoring purposes (not stored server-side due to stateless requirement).

**Fields** (in conceptual model):
- `session_id`: String (JWT ID from token)
- `user_id`: UUID (Reference to User)
- `issued_at`: DateTime (Time of token issuance)
- `expires_at`: DateTime (Time of token expiration)
- `last_used`: DateTime (Last time token was validated)
- `ip_address`: String (IP address of client - for security tracking)

**Note**: Since the system is stateless, actual session data is not stored server-side. This is for conceptual understanding only.

## Database Schema

### Users Table (Managed by Better Auth)
Better Auth manages the users table with appropriate fields for authentication. The application may reference this table through foreign keys.

### Application Tables with User Reference
Any application tables requiring user ownership will reference the Better Auth user ID:

```sql
-- Example task table with user reference
CREATE TABLE tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(255) NOT NULL,
    description TEXT,
    completed BOOLEAN DEFAULT FALSE,
    due_date TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    owner_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE  -- Reference to Better Auth users
);

CREATE INDEX idx_tasks_owner_id ON tasks(owner_id);
```

## Business Logic Constraints

1. **Authentication Requirement**: All API endpoints require valid JWT token
2. **User Isolation**: Users can only access resources where owner_id matches their user ID
3. **Token Validation**: All tokens must be properly signed and not expired
4. **User Identity**: User ID must be extracted from JWT token, not client input
5. **Statelessness**: No server-side session storage - all authentication state in JWT

## API Representation

### User Profile Response
```json
{
  "user_id": "uuid-string",
  "email": "user@example.com",
  "username": "optional_username",
  "created_at": "2023-01-01T12:00:00Z"
}
```

### Authentication Response
```json
{
  "access_token": "jwt-token-string",
  "token_type": "bearer",
  "expires_in": 1800
}
```

### Error Response for Authentication
```json
{
  "detail": "Unauthorized" or "Forbidden" or "Invalid token"
}
```

### JWT Claims Structure
```json
{
  "sub": "user-uuid-string",
  "iat": 1678886400,
  "exp": 1678888200,
  "iss": "better-auth-server",
  "aud": "todo-app-backend"
}
```